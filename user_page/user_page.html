<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Page</title>
  <link rel="stylesheet" href="../common/header.css">
  <link rel="stylesheet" href="user_page.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/a9dbad3c27.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="../common/common.js"></script>
</head>
<body>

  <header class="header">
    <div></div>
    <img src="../byd.png" alt="BYD Furniture Logo" class="logo" />
    <div></div>
  </header>

    <!-- 🔁 Loader added -->
    <div id="loader" style="display: flex; justify-content: center; align-items: center; height: 60vh;">
      <iframe src="https://lottie.host/embed/0a2e16ad-d163-4be1-8c79-31a912d3893e/efW07Kdq39.lottie" 
              style="width: 300px; height: 300px; border: none;"></iframe>
    </div>

 
    
  <div class="users" id="usersContainer">
    <!-- Dynamic users will be inserted here -->
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script> <!-- ADD THIS LINE -->


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBSncXH9TG_q9VyJcn377j7YKESFC-KChI",
      authDomain: "byd-furniture-36585.firebaseapp.com",
      databaseURL: "https://byd-furniture-36585-default-rtdb.firebaseio.com",
      projectId: "byd-furniture-36585",
      storageBucket: "byd-furniture-36585.appspot.com",
      messagingSenderId: "133527815399",
      appId: "1:133527815399:web:8ef671206d0478824ece42"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Initialize Firebase first (as usual)
// Add this code after Firebase initialization

const auth = firebase.auth();

auth.onAuthStateChanged((user) => {
  if (!user) {
    // If not signed in, redirect to login
    window.location.href = "../loginpage.html";
  }
});

    const usersContainer = document.getElementById("usersContainer");
    const loader = document.getElementById("loader");

    function createUserBox(name, product, fullPayment, purchaseData) {
      const div = document.createElement("div");
      div.className = "user";
      div.innerHTML = `
        <h1>${name}</h1>
        <h2>${product}</h2>
        <h3>${fullPayment ? "Full Payment" : "Half Payment"}</h2>
      `;

      // 👉 Log full purchase data on click
      div.addEventListener("click", () => {
        localStorage.setItem("selectedPurchase", JSON.stringify(purchaseData));
        window.location.href = "../client/client.html";
      });


      usersContainer.appendChild(div);
    }

    function createAddButtons() {
      const addUser = document.createElement("a");
      addUser.href = "../Product_and_form/product.html";
      addUser.innerHTML = `
        <div class="user">
          <i class="fa-solid fa-plus"></i>
          <h1>Add User</h1>
        </div>
      `;
      const addProduct = document.createElement("a");
      addProduct.href = "../New-Product/new-product.html";
      addProduct.innerHTML = `
      <div class="user">
        <i class="fa-solid fa-plus"></i>
        <h1>Add Product</h1>
      </div>
      `;
      usersContainer.appendChild(addUser);
      usersContainer.appendChild(addProduct);
    }

    function createUserBox(name, productNames, fullPayment, purchaseData) {
  const div = document.createElement("div");
  div.className = "user";
  div.innerHTML = `
    <h1>${name}</h1>
    <h2>${productNames}</h2>
    <h3>${fullPayment ? "Full Payment" : "Half Payment"}</h2>
  `;

  div.addEventListener("click", () => {
    localStorage.setItem("selectedPurchase", JSON.stringify(purchaseData));
    window.location.href = "../client/client.html";
  });

  usersContainer.appendChild(div);
}

function showLoader() {
  loader.style.visibility = "visible";
  loader.style.opacity = "1";
  usersContainer.style.visibility = "hidden";
  usersContainer.style.opacity = "0";
}

function hideLoader() {
  loader.style.visibility = "hidden";
  loader.style.opacity = "0";
  loader.style.height="0"
  usersContainer.style.visibility = "visible";
  usersContainer.style.opacity = "1";
}

    // Show loader immediately
    showLoader();

firebase.auth().onAuthStateChanged(user => {
  if (!user) return;
  

  db.ref("purchases").once("value").then(snapshot => {
      const data = snapshot.val();
      if (!data) return createAddButtons();
      

      // Convert to array and sort by latest
      const purchases = Object.entries(data)
        .map(([key, purchase]) => {
          purchase.key = key;
          return purchase;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date)); // sort newest first
        createAddButtons();

      purchases.forEach(purchase => {
        const name = purchase.customerName || "Unknown";
        const fullPayment = purchase.fullPayment;
        const productNames = (purchase.products || []).map(p => p.name || "Unnamed Product").join(", ");
        createUserBox(name, productNames, fullPayment, purchase);
      });



      hideLoader()
    });

}
);
    </script>

</body>
</html>
